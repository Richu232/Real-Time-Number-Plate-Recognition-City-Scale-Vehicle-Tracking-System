<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Detection Map & Timeline</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis-timeline/7.7.0/vis-timeline-graph2d.min.css" />
    
    <style>
        /* Fullscreen Map */
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            height: 100%;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Map Container */
        .map-container {
            display: flex;
            flex: 3;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h2 {
            text-align: center;
            font-size: 22px;
            margin-bottom: 15px;
        }

        .detection-details {
            font-size: 16px;
            line-height: 1.6;
        }

        .detection-details span {
            display: block;
            margin-bottom: 10px;
        }

        .plate-info {
            background: #34495e;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        /* Map */
        #map {
            flex: 1;
            height: 100%;
        }

        /* Timeline */
        .timeline-container {
            flex: 1;
            min-height: 200px;
            border-top: 2px solid #2c3e50;
        }

        #timeline {
            width: 100%;
            height: 100%;
        }

        /* Floating Panel */
        .floating-panel {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.2);
            font-weight: bold;
            z-index: 1000;
        }

        /* Search Panel */
        .search-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 300px;
        }

        .search-panel h3 {
            margin-top: 0;
            margin-bottom: 15px;
        }

        .search-panel input, .search-panel select {
            padding: 8px;
            width: 100%;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        .search-panel button {
            padding: 8px 15px;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            width: 100%;
        }

        .search-panel button:hover {
            background: #34495e;
        }
        
        /* Detection marker styles */
        .detection-marker {
            text-align: center;
            font-weight: bold;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        
        /* Timeline styles */
        .vis-item {
            border-color: #2c3e50;
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        
        .vis-item .vis-item-content {
            padding: 5px;
        }
        
        .vis-timeline {
            border: 1px solid #ddd;
        }
        
        /* For the plate image in the popup */
        .popup-image {
            max-width: 150px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Map Container -->
        <div class="map-container">
            <!-- Sidebar -->
            <div class="sidebar">
                <h2>üöó Vehicle Tracking</h2>
                <div class="plate-info">
                    <h3 id="plate-display">No Plate Selected</h3>
                    <p id="detection-count">Detections: 0</p>
                </div>
                <div id="detection-info" class="detection-details">
                    <span>Search for a plate number to see detection details.</span>
                </div>
            </div>

            <!-- Map -->
            <div id="map"></div>
        </div>
        
        <!-- Timeline -->
        <div class="timeline-container">
            <div id="timeline"></div>
        </div>
    </div>

    <!-- Floating Panel for Route Distance -->
    <div class="floating-panel" id="distance-panel">No Route Selected</div>

    <!-- Search Panel -->
    <div class="search-panel">
        <h3>Vehicle Tracking</h3>
        <input type="text" id="plate-input" placeholder="Enter plate number">
        <input type="date" id="date-input">
        <select id="fuzzy-mode">
            <option value="default">Default Fuzzy Matching</option>
            <option value="strict">Strict Matching</option>
            <option value="relaxed">Relaxed Matching</option>
        </select>
        <button id="search-btn">Search</button>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <!-- Timeline Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-timeline/7.7.0/vis-timeline-graph2d.min.js"></script>

    <script>
        // Initialize the map
        var map = L.map('map').setView([18.5204, 73.8567], 12);

        // Load OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Group for markers
        var markersGroup = L.layerGroup().addTo(map);
        
        // Variable to store current route control
        var currentRouteControl = null;

        // Custom marker colors based on detection index
        const markerColors = [
            '#e74c3c', // Red
            '#e67e22', // Orange
            '#f1c40f', // Yellow
            '#2ecc71', // Green
            '#3498db', // Blue
            '#9b59b6', // Purple
            '#1abc9c', // Teal
            '#d35400', // Dark Orange
            '#27ae60', // Dark Green
            '#2980b9'  // Dark Blue
        ];

        // Function to create a custom HTML marker
        function createMarkerIcon(number) {
            const colorIndex = (number - 1) % markerColors.length;
            const markerHtml = `
                <div class="detection-marker" style="background-color: ${markerColors[colorIndex]}; width: 30px; height: 30px; color: white;">
                    ${number}
                </div>
            `;
            
            return L.divIcon({
                html: markerHtml,
                className: 'custom-marker',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
        }

        // Initialize Timeline
        var timelineContainer = document.getElementById('timeline');
        var timeline = new vis.Timeline(timelineContainer, [], {});

        // Function to format date for display
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString();
        }

        // Function to display vehicle detections on map and timeline
        // Function to display vehicle detections on map and timeline
    function displayDetections(data) {
        // Clear previous markers and route
        markersGroup.clearLayers();
        if (currentRouteControl) {
            map.removeControl(currentRouteControl);
            currentRouteControl = null;
        }
        
        // Update plate info
        document.getElementById('plate-display').textContent = `Plate: ${data.plate_number}`;
        
        // Check if we have any matches
        if (!data.matches || data.matches.length === 0) {
            document.getElementById('detection-count').textContent = `Detections: 0`;
            document.getElementById('detection-info').innerHTML = `<span>No detections found for this plate number.</span>`;
            document.getElementById('distance-panel').textContent = 'No Detections Found';
            timeline.setItems([]);
            return;
        }

        // Use the actual structure from the API
        let matches = data.matches;
        document.getElementById('detection-count').textContent = `Locations: ${matches.length}`;
        
        // Prepare coordinates for routing
        let coordinates = [];
        let timelineItems = [];
        let detectionDetails = '';
        
        // Add markers and prepare timeline items for each location group
        matches.forEach((location, locationIndex) => {
            // Skip locations without coordinates
            if (!location.latitude || !location.longitude) return;
            
            const position = [parseFloat(location.latitude), parseFloat(location.longitude)];
            coordinates.push(position);
            const markerNumber = locationIndex + 1;
            
            // Create marker with custom icon
            const marker = L.marker(position, {
                icon: createMarkerIcon(markerNumber)
            });
            
            // Create popup content
            let popupContent = `
                <strong>Location #${markerNumber}</strong><br>
                Plate: ${location.plate_number}<br>
                Location: ${location.location_name || 'Unknown'}<br>
                Period: ${formatDate(location.start_time)} - ${formatDate(location.end_time)}<br>
                Count: ${location.count} detection(s)
            `;
            
            // Add image if available
            if (location.image_urls && location.image_urls.length > 0) {
                popupContent += `<br><img src="${location.image_urls[0]}" class="popup-image">`;
            }
            
            marker.bindPopup(popupContent);
            markersGroup.addLayer(marker);
            
            // Create timeline item - each location becomes a range on the timeline
            timelineItems.push({
                id: markerNumber,
                content: `#${markerNumber}: ${location.location_name || 'Unknown'}`,
                start: new Date(location.start_time),
                end: new Date(location.end_time),
                title: `Plate: ${location.plate_number}, Location: ${location.location_name || 'Unknown'}, Detections: ${location.count}`
            });
            
            // Add to detection details in sidebar
            detectionDetails += `
                <span><strong>#${markerNumber}</strong> - ${location.location_name || 'Unknown Location'}</span>
                <span>‚è±Ô∏è ${formatDate(location.start_time)} to ${formatDate(location.end_time)}</span>
                <span>üî¢ ${location.count} detection(s)</span>
                <hr>
            `;
        });
        
        // Update sidebar with detection details
        document.getElementById('detection-info').innerHTML = detectionDetails;
        
        // Only create route if we have multiple points
        if (coordinates.length > 1) {
            // Sort coordinates by detection time
            let sortedCoordinates = [...coordinates]; // Create a copy of coordinates
            
            // Create a simple polyline first to ensure we have a visible route
            let polyline = L.polyline(sortedCoordinates, {
                color: '#3498db',
                weight: 4,
                opacity: 0.7,
                lineJoin: 'round'
            }).addTo(map);
            
            // Create waypoints for routing
            const waypoints = sortedCoordinates.map(coord => L.latLng(coord[0], coord[1]));
            
            // Create route with OSRM
            try {
                currentRouteControl = L.Routing.control({
                    waypoints: waypoints,
                    routeWhileDragging: false,
                    showAlternatives: false,
                    fitSelectedRoutes: false,
                    createMarker: function() { return null; }, // Hide default markers
                    lineOptions: {
                        styles: [{ color: '#3498db', opacity: 0.7, weight: 5 }],
                        addWaypoints: false
                    },
                    router: L.Routing.osrmv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1',
                        timeout: 10000 // Increase timeout
                    })
                }).addTo(map);
                
                // Event listener to update route details
                currentRouteControl.on('routesfound', function(e) {
                    // Remove the simple polyline once the route is found
                    if (polyline) {
                        map.removeLayer(polyline);
                        polyline = null;
                    }
                    
                    const distance = (e.routes[0].summary.totalDistance / 1000).toFixed(2);
                    document.getElementById("distance-panel").innerHTML = `Total Distance: ${distance} km`;
                });
                
                // Handle routing errors
                currentRouteControl.on('routingerror', function(e) {
                    console.error('Routing error:', e.error);
                    // Keep the simple polyline if routing fails
                    document.getElementById("distance-panel").innerHTML = `Routing unavailable - showing direct line`;
                    
                    // Calculate approximate distance of the direct route
                    let totalDistance = 0;
                    for (let i = 0; i < sortedCoordinates.length - 1; i++) {
                        totalDistance += haversineDistance(
                            sortedCoordinates[i][0], sortedCoordinates[i][1],
                            sortedCoordinates[i+1][0], sortedCoordinates[i+1][1]
                        );
                    }
                    document.getElementById("distance-panel").innerHTML = `Approx. Distance: ${totalDistance.toFixed(2)} km (direct)`;
                });
            } catch (error) {
                console.error('Error creating route:', error);
                // Keep the simple polyline as fallback
                document.getElementById("distance-panel").innerHTML = `Using direct line - ${error.message}`;
            }
            
            // Fit map to show all markers
            const bounds = L.latLngBounds(coordinates);
            map.fitBounds(bounds, { padding: [50, 50] });
        } else if (coordinates.length === 1) {
            // If only one detection, center on it
            map.setView(coordinates[0], 15);
            document.getElementById("distance-panel").innerHTML = `Single Detection Point`;
        }
        
        // Set timeline items and options
        const timelineOptions = {
            editable: false,
            tooltip: {
                followMouse: true,
                overflowMethod: 'cap'
            },
            zoomable: true
        };
        
        timeline.setOptions(timelineOptions);
        timeline.setItems(timelineItems);
        
        // Focus timeline on data range
        if (timelineItems.length > 0) {
            timeline.fit();
        }
        
        // Add click event to timeline items
        timeline.on('click', function(properties) {
            if (properties.item) {
                const markerIndex = parseInt(properties.item) - 1;
                if (markerIndex >= 0 && markerIndex < markersGroup.getLayers().length) {
                    // Open the popup for the clicked marker
                    markersGroup.getLayers()[markerIndex].openPopup();
                    // Center map on the marker
                    map.setView(coordinates[markerIndex], 15);
                }
            }
        });
    }

    // Haversine distance calculation function
    function haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Radius of the Earth in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2); 
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        return R * c; // Distance in km
    }

        // Function to search for plate detections
        function searchPlate() {
            const plateNumber = document.getElementById('plate-input').value.trim();
            if (!plateNumber) {
                alert('Please enter a plate number');
                return;
            }
            
            // Build query parameters
            let params = new URLSearchParams();
            params.append('plate_number', plateNumber);
            
            // Add date if provided
            const searchDate = document.getElementById('date-input').value;
            if (searchDate) params.append('search_date', searchDate);
            
            // Add fuzzy mode
            const fuzzyMode = document.getElementById('fuzzy-mode').value;
            params.append('fuzzy_mode', fuzzyMode);
            
            // Make API request
            fetch(`/track-vehicle/?${params.toString()}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('API response:', data); // Debug log
                    displayDetections(data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    alert(`Error fetching vehicle data: ${error.message}`);
                });
        }

        // Add event listener to search button
        document.getElementById('search-btn').addEventListener('click', searchPlate);
        
        // Allow Enter key to trigger search
        document.getElementById('plate-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchPlate();
            }
        });
        
        // Initialize with no data
        document.getElementById('distance-panel').textContent = 'Enter a plate number to start tracking';
    </script>
</body>
</html>